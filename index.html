<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Letter From My Heart</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for the Heart Animation and special font */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fce4ec; /* Light pink background */
        }

        /* 1. Heart Shape */
        .heart {
            position: relative;
            width: 50px;
            height: 50px;
            background-color: #e91e63; /* Deep pink for the heart */
            transform: rotate(-45deg);
            box-shadow: 0 4px 10px rgba(233, 30, 99, 0.4);
            animation: beat 1.5s infinite ease-in-out alternate, float 6s infinite ease-in-out;
            cursor: pointer;
            transition: transform 0.2s ease-out;
        }

        .heart:before,
        .heart:after {
            content: "";
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #e91e63;
            border-radius: 50%;
        }

        .heart:before {
            top: -25px;
            left: 0;
        }

        .heart:after {
            left: 25px;
            top: 0;
        }

        /* 2. Beating/Pulsing Animation */
        @keyframes beat {
            0% {
                transform: scale(1) rotate(-45deg);
                box-shadow: 0 4px 10px rgba(233, 30, 99, 0.4);
            }
            50% {
                transform: scale(1.15) rotate(-45deg);
                box-shadow: 0 8px 20px rgba(233, 30, 99, 0.7);
            }
            100% {
                transform: scale(1) rotate(-45deg);
            }
        }

        /* 3. Floating/Drifting Animation */
        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(-45deg);
            }
            25% {
                transform: translate(5px, 10px) rotate(-45deg);
            }
            50% {
                transform: translate(0, 5px) rotate(-45deg);
            }
            75% {
                transform: translate(-5px, 10px) rotate(-45deg);
            }
            100% {
                transform: translate(0, 0) rotate(-45deg);
            }
        }
        
        /* Message Styling */
        .handwriting {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem; /* Larger font for the main message */
            color: #4a5568;
        }

        /* Music Button Icon */
        .music-btn {
            background-color: #e91e63;
            box-shadow: 0 4px 10px rgba(233, 30, 99, 0.6);
        }
        .music-btn:hover {
            background-color: #f06292;
        }
    </style>
</head>
<body>

    <div id="love-letter-container" class="max-w-md w-full mx-4 p-8 bg-white rounded-xl shadow-2xl transition-all duration-500 hover:shadow-pink-300/80">
        
        <!-- Opening Header - Added ID and transition for margin change -->
        <h1 id="main-title" class="text-2xl font-bold text-center mb-4 text-pink-600 font-['Playfair_Display'] transition-all duration-500">
            Surat Cinta untuk Wanita Impianku, Lilis Setiyorini
        </h1>
        <p class="text-center text-gray-500 mb-8 subtitle transition-opacity duration-500">
            Click the heart
        </p>

        <!-- Animated Heart Element (Added transition-opacity duration-500) -->
        <div id="heart-trigger" class="flex justify-center mb-10 transition-opacity duration-500">
            <div class="heart"></div>
        </div>

        <p class="text-center text-gray-500 mb-8 subtitle transition-opacity duration-500">
            Ada musik, dengarkan dengan headset yaa...
        </p>

        <!-- Hidden Message Container -->
        <div id="message-container" class="hidden space-y-6 text-center">
            
            <p class="handwriting text-lg md:text-lg leading-relaxed text-gray-700 border-t border-b py-4 border-pink-200">
                Hai Lily... ü•∞
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Dengan segala kerendahan hati, melalui surat ini, aku ingin memberitahumu segenap perasaan tulusku untukmu. üíù
            </p>
            
            <p class="handwriting text-base md:text-lg text-gray-600">
                Aku memang bukanlah orang yang kamu kenal, kita tidak pernah saling bertemu di real life. Jadi aku tidak punya kapasitas untuk mengatakan bahwa aku menyukaimu.. kamu pasti akan meragukannya. ü•∫
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Jadi aku akan menyampaikan sekali lagi apa yang pernah aku sampaikan di Bumble 2 tahun yang lalu... ü´∞
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Lily, aku ingin mendaftar untuk menjadi kandidat calonmu, apa saja persyaratannya? ü§≠
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Waktu itu kamu menjawab "Baru 2 hari kenal bang kwwkw, How do you know that I'm a good people?" üò≠
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Jadi aku menjawab seperti ini...
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Hehe... kecepetan ya? Kamu pasti orang yg baik Lily, I just want believe it.
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Kalau kamu merasa ini terlalu cepat, anggap aja aku sedang apply to be your life-partner, jobdesknya adalah make you happy for a whole of my life, 
                ada tahap-tahap selanjutnya yang harus aku lalui seperti seleksi berkas, seleksi wawancara, wawancara dengan pihak keluarga dll. Mungkin semuanya akan
                membutuhkan waktu yang cukup lama sampai kamu benar-benar yakin untuk menerimaku. Tapi kalau di tengah jalan kamu merasa fisikku atau kepribadianku tidak sesuai dengan 
                ekspektasimu, you are free to dismiss my application. ü•∞
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Lily... Selama 2 tahun ini, aku memperbaiki diriku, aku memperbaiki ibadahku, aku memperbaiki karirku, aku benar-benar ingin memantaskan diriku untukmu. Dan sekarang aku sudah jadi versi terbaik dari diriku. Aku siap untuk mendaftar lagi. ¬†ü•∞
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Lily, aku pengen ngasi tau kamu beberapa keuntungan kalau kamu menerimaku. hehe. ü§≠
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Yang pertama, aku akan mencintaimu sepenuh hati, setiap hari, seumur hidupku, dengan segenap ketulusan. Aku akan meratukanmu dan membahagiakanmu dengan seluruh tenaga dan kekuatanku. ü•∞
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Yang kedua, aku akan mengusahakan apapun keinginanmu. Aku akan buktiin kalau aku adalah seorang laki-laki yang pekerja keras dan aku nggak akan pernah membiarkanmu turun level. üëå
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Yang ketiga, aku juga suka traveling lho.. ciuzz. ‚úåÔ∏è Aku sekarang udah punya uang untuk ngajak kamu jalan-jalan ke luar negeri, bahkan kuliah S2 di Eropa. Semuanya akan aku usahakan agar kamu bahagia Lily... ü´∞ 
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Gimana? enak kan? üòò
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Lily, aku ingin menyukai semua yang kamu sukai, aku ingin memilih semua yang kamu pilih, aku ingin membela semua yang kamu bela. üíù
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Eh... tau nggak, aku sering menceritakan tentangmu ke ibuku, aku bilang kalau kamu adalah wanita impianku, cantik, pinter, Lulusan Teknik Biosystem IPB, pemenang Lomba Karya Tulis Ilmiah. Dan aku cerita bahwa kamu juga baik dan sopan, setiap kata-katamu positif, wanita idaman lah pokoknya. ü§≠
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Aku memberikan surat cinta ini kepadamu sebagai berkas utamaku untuk mendaftar menjadi kandidat calon suamimu. Aku harap kamu suka dengan tampilannya. üòÅ
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Jika kamu merasa aku cukup layak untuk lanjut ke tahap berikutnya, klik tombol di bawah ini yaa... ü•∞
            </p>

            <p class="handwriting text-base md:text-lg text-gray-600">
                Kamu adalah wanita impianku, Lily... üíù
            </p>
            

            <div class="pt-6">
                <p class="handwriting text-xl text-pink-700 font-semibold">‚Äî Azzam</p>
                <p class="text-sm text-gray-400 mt-1">October 8th, 2025</p>
            </div>
        </div>
    </div>

    <!-- Floating Music Control -->
    <button id="music-control-container" onclick="toggleMusic()" class="fixed bottom-6 right-6 p-3 rounded-full text-white transition duration-300 z-40 hidden music-btn">
        <!-- Icon for Speaker (using inline SVG for simplicity) -->
        <svg id="music-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
    </button>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

        // --- WEBHOOK CONFIGURATION ---
        // GANTI URL INI dengan URL Webhook unik Anda (misalnya dari Webhook.site)
        const WEBHOOK_URL = 'YOUR_UNIQUE_WEBHOOK_URL_HERE';
        // -----------------------------

        // Global Firebase variables
        let db, auth, app, userId = null;
        let isAuthReady = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        if (firebaseConfig) {
            setLogLevel('Debug');
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Set up Authentication Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                } else {
                    console.log("Attempting sign in...");
                    // Try to sign in using the provided token or anonymously
                    if (typeof __initial_auth_token !== 'undefined') {
                        signInWithCustomToken(auth, __initial_auth_token).catch(e => console.error("Custom token sign-in failed:", e));
                    } else {
                        signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                    }
                }
            });
        } else {
            console.error("Firebase config is missing.");
        }

        // --- Existing App Logic ---

        // Music variables for native HTML5 Audio
        let audio = null;
        const MUSIC_FILE = 'love_song.mp3'; // *** RENAME YOUR MP3 FILE TO THIS ***
        let isMusicPlaying = false;
        
        // Get elements
        const heartTrigger = document.getElementById('heart-trigger');
        const messageContainer = document.getElementById('message-container');
        const musicControl = document.getElementById('music-control-container');
        const musicIcon = document.getElementById('music-icon');
        const subtitleElements = document.querySelectorAll('.subtitle'); // Select all subtitle paragraphs
        const mainTitle = document.getElementById('main-title'); // Get the main title element
        
        // Use a state to prevent multiple clicks and track initialization
        let isRevealed = false;
        let isMusicInitialized = false;

        /**
         * Records an event to Firestore indicating the letter was opened.
         */
        async function recordLetterOpenedEvent() {
            if (!db || !isAuthReady || !userId) {
                console.error("Database or authentication not ready. Skipping event recording.");
                return;
            }

            // Store in a public collection so the sender can see it
            const eventsCollectionPath = `/artifacts/${appId}/public/data/letter_events`;
            const eventData = {
                openedBy: userId, // The unique ID of the person who opened it
                event: "Letter_Opened",
                timestamp: serverTimestamp(),
                readableDate: new Date().toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'long' }),
                message: `The love letter was opened by a user with ID: ${userId}`,
            };

            try {
                await addDoc(collection(db, eventsCollectionPath), eventData);
                console.log("Letter opened event recorded successfully to Firestore.");
            } catch (e) {
                console.error("Error recording event to Firestore:", e);
            }
        }

        /**
         * Sends a notification payload to a configured external Webhook URL.
         */
        async function sendWebhookNotification(eventData) {
            if (WEBHOOK_URL === 'https://webhook.site/bbe61aca-1fee-43a0-93f6-ae53e4220c0b' || !WEBHOOK_URL) {
                console.warn("Webhook URL is not configured. Skipping external notification.");
                return;
            }

            const payload = {
                // Formatting a simple message for easy viewing in webhook logs
                text: `[ALERT] üíñ SURAT DIBUKA! üíñ \n\nDibuka oleh ID Pengguna: ${eventData.openedBy}\nWaktu: ${new Date().toLocaleString('en-US')}`,
                
                // You can add more detailed JSON if targeting specific platforms like Slack/Discord
                details: eventData
            };

            try {
                // Using fetch to send a simple POST request
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                // Note: Check response status, but ignore content for most webhooks
                if (response.ok) {
                    console.log("Webhook notification sent successfully.");
                } else {
                     console.error("Webhook failed to send or returned error status:", response.status);
                }
            } catch (e) {
                console.error("Error sending webhook notification:", e);
            }
        }


        /**
         * Initializes the Audio object and starts playback of the MP3 file.
         */
        async function startMusic() {
            if (!isMusicInitialized) {
                audio = new Audio(MUSIC_FILE);
                audio.loop = true; // Make it loop automatically
                audio.volume = 0.6; // Set a reasonable volume
                isMusicInitialized = true;
            }

            try {
                // Play starts the audio, requiring a user gesture (the click)
                await audio.play();
                isMusicPlaying = true;
            } catch (error) {
                console.error("Autoplay prevented or file not found:", error);
                isMusicPlaying = false; 
            }
            updateMusicIcon();
        }

        /**
         * Toggles the play/pause state of the music.
         */
        function toggleMusic() {
            if (!audio) return;

            if (isMusicPlaying) {
                audio.pause();
                isMusicPlaying = false;
            } else {
                audio.play();
                isMusicPlaying = true;
            }
            updateMusicIcon();
        }

        /**
         * Updates the music control icon based on the playback state.
         */
        function updateMusicIcon() {
            if (isMusicPlaying) {
                // Speaker with waves (Volume 2)
                musicIcon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>';
            } else {
                // Speaker with X (Mute)
                musicIcon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line>';
            }
        }

        /**
         * Toggles the visibility of the secret message and records the event.
         */
        heartTrigger.addEventListener('click', async () => {
            if (!isRevealed) {
                isRevealed = true; // Set immediately to prevent double-click

                // 1. Reveal the message and start music (MP3)
                messageContainer.classList.remove('hidden');
                await startMusic();

                // 2. Start fade out for the heart container (it stays in the layout flow, but transparent)
                heartTrigger.classList.add('opacity-0');
                heartTrigger.style.pointerEvents = 'none'; // Disable further clicks

                // 3. INCREASE MARGIN BELOW TITLE
                // Change default mb-4 to a larger mb-12 to create separation
                mainTitle.classList.remove('mb-4');
                mainTitle.classList.add('mb-12'); 

                // 4. Fade out all subtitle messages smoothly
                subtitleElements.forEach(subtitle => {
                    subtitle.classList.add('opacity-0');
                    
                    // Wait for the opacity transition (500ms) to complete, then hide the subtitles completely.
                    setTimeout(() => {
                        subtitle.classList.add('hidden'); 
                    }, 500);
                });

                // 5. Show music control
                musicControl.classList.remove('hidden');

                // 6. Record the event to Firestore (still good for logging)
                await recordLetterOpenedEvent();

                // 7. Send the Webhook notification (the new notification mechanism)
                // We must wait for auth to be ready to get the user ID, so we poll for it briefly.
                const checkAuthAndNotify = () => {
                    if (isAuthReady && userId) {
                        const eventData = { openedBy: userId, event: "Letter_Opened", appId: appId };
                        sendWebhookNotification(eventData);
                    } else if (!isAuthReady) {
                        // Retry quickly if auth is still initializing
                        setTimeout(checkAuthAndNotify, 100);
                    } else {
                        // Fallback if userId is somehow missing
                        sendWebhookNotification({ openedBy: 'Unknown User', event: "Letter_Opened", appId: appId });
                    }
                };
                checkAuthAndNotify();
            }
        });

    </script>
</body>
</html>
